
name: Docker Build
on:
  pull_request:
  push:
    branches:
      - master
  schedule:
    - cron: '42 2 * * 2'

jobs:
  docker-build-dockerfiles-builder:
    name: docker build dockerfiles-builder
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/dockerfiles-builder:${{ github.sha }} --load dockerfiles-builder/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/dockerfiles-builder:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/dockerfiles-builder:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/dockerfiles-builder:${{ github.sha }} --push dockerfiles-builder/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/dockerfiles-builder:${{ github.sha }} --push dockerfiles-builder/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/dockerfiles-builder:${{ github.sha }} \
          ghcr.io/hairyhenderson/dockerfiles-builder:latest
        docker buildx imagetools create \
          -t hairyhenderson/dockerfiles-builder:${{ github.sha }} \
          hairyhenderson/dockerfiles-builder:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-figlet:
    name: docker build figlet
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/figlet:${{ github.sha }} --load figlet/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/figlet:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/figlet:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/figlet:${{ github.sha }} --push figlet/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/figlet:${{ github.sha }} --push figlet/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/figlet:${{ github.sha }} \
          ghcr.io/hairyhenderson/figlet:latest
        docker buildx imagetools create \
          -t hairyhenderson/figlet:${{ github.sha }} \
          hairyhenderson/figlet:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-golang-air:
    name: docker build golang-air
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/golang-air:${{ github.sha }} --load golang-air/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/golang-air:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/golang-air:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/golang-air:${{ github.sha }} --push golang-air/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/golang-air:${{ github.sha }} --push golang-air/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/golang-air:${{ github.sha }} \
          ghcr.io/hairyhenderson/golang-air:latest
        docker buildx imagetools create \
          -t hairyhenderson/golang-air:${{ github.sha }} \
          hairyhenderson/golang-air:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-gomplate-ci-build:
    name: docker build gomplate-ci-build
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/gomplate-ci-build:${{ github.sha }} --load gomplate-ci-build/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/gomplate-ci-build:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/gomplate-ci-build:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/gomplate-ci-build:${{ github.sha }} --push gomplate-ci-build/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/gomplate-ci-build:${{ github.sha }} --push gomplate-ci-build/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/gomplate-ci-build:${{ github.sha }} \
          ghcr.io/hairyhenderson/gomplate-ci-build:latest
        docker buildx imagetools create \
          -t hairyhenderson/gomplate-ci-build:${{ github.sha }} \
          hairyhenderson/gomplate-ci-build:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-jwt:
    name: docker build jwt
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/jwt:${{ github.sha }} --load jwt/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/jwt:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/jwt:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/jwt:${{ github.sha }} --push jwt/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/jwt:${{ github.sha }} --push jwt/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/jwt:${{ github.sha }} \
          ghcr.io/hairyhenderson/jwt:latest
        docker buildx imagetools create \
          -t hairyhenderson/jwt:${{ github.sha }} \
          hairyhenderson/jwt:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-man:
    name: docker build man
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/man:${{ github.sha }} --load man/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/man:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/man:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/man:${{ github.sha }} --push man/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/man:${{ github.sha }} --push man/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/man:${{ github.sha }} \
          ghcr.io/hairyhenderson/man:latest
        docker buildx imagetools create \
          -t hairyhenderson/man:${{ github.sha }} \
          hairyhenderson/man:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-remarkjs:
    name: docker build remarkjs
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/remarkjs:${{ github.sha }} --load remarkjs/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/remarkjs:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/remarkjs:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/remarkjs:${{ github.sha }} --push remarkjs/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/remarkjs:${{ github.sha }} --push remarkjs/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/remarkjs:${{ github.sha }} \
          ghcr.io/hairyhenderson/remarkjs:latest
        docker buildx imagetools create \
          -t hairyhenderson/remarkjs:${{ github.sha }} \
          hairyhenderson/remarkjs:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-sed:
    name: docker build sed
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/sed:${{ github.sha }} --load sed/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/sed:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/sed:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/sed:${{ github.sha }} --push sed/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/sed:${{ github.sha }} --push sed/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/sed:${{ github.sha }} \
          ghcr.io/hairyhenderson/sed:latest
        docker buildx imagetools create \
          -t hairyhenderson/sed:${{ github.sha }} \
          hairyhenderson/sed:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-socat:
    name: docker build socat
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/socat:${{ github.sha }} --load socat/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/socat:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/socat:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/socat:${{ github.sha }} --push socat/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/socat:${{ github.sha }} --push socat/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/socat:${{ github.sha }} \
          ghcr.io/hairyhenderson/socat:latest
        docker buildx imagetools create \
          -t hairyhenderson/socat:${{ github.sha }} \
          hairyhenderson/socat:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-ssh:
    name: docker build ssh
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/ssh:${{ github.sha }} --load ssh/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/ssh:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/ssh:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/ssh:${{ github.sha }} --push ssh/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/ssh:${{ github.sha }} --push ssh/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/ssh:${{ github.sha }} \
          ghcr.io/hairyhenderson/ssh:latest
        docker buildx imagetools create \
          -t hairyhenderson/ssh:${{ github.sha }} \
          hairyhenderson/ssh:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-trx:
    name: docker build trx
    runs-on: ubuntu-20.04
    env:
      DOCKER_BUILDKIT: 1
      DOCKER_CLI_EXPERIMENTAL: enabled
    steps:
    - name: enable experimental mode
      run: |
        mkdir -p ~/.docker
        echo '{"experimental": "enabled"}' > ~/.docker/config.json
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1.2.0
    - name: Set up Docker Buildx
      id: buildx
      uses: docker/setup-buildx-action@v1.6.0
      with:
        version: v0.7.0
        driver-opts: |
          image=moby/buildkit:buildx-stable-1
          network=host
    - name: Available platforms
      run: echo ${{ steps.buildx.outputs.platforms }}
    - name: Build (non-master branch)
      run: |
        docker buildx build --tag ghcr.io/hairyhenderson/trx:${{ github.sha }} --load trx/
      if: github.repository == 'hairyhenderson/dockerfiles'
    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/trx:${{ github.sha }}'
        format: 'table'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ghcr.io/hairyhenderson/trx:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: Login to GHCR
      uses: docker/login-action@v1.10.0
      with:
          registry: ghcr.io
          username: '${{ github.actor }}'
          password: '${{ secrets.GHCR_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Login to DockerHub
      uses: docker/login-action@v1.10.0
      with:
          username: '${{ github.actor }}'
          password: '${{ secrets.DOCKERHUB_TOKEN }}'
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
    - name: Build & Push (master branch)
      run: |
        PLATFORMS=linux/amd64,linux/arm64,linux/arm/v6,linux/arm/v7

        docker buildx build \
          --platform $PLATFORMS \
          --tag ghcr.io/hairyhenderson/trx:${{ github.sha }} --push trx/
        docker buildx build \
          --platform $PLATFORMS \
          --tag hairyhenderson/trx:${{ github.sha }} --push trx/

        docker buildx imagetools create \
          -t ghcr.io/hairyhenderson/trx:${{ github.sha }} \
          ghcr.io/hairyhenderson/trx:latest
        docker buildx imagetools create \
          -t hairyhenderson/trx:${{ github.sha }} \
          hairyhenderson/trx:latest
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson' && github.ref == 'refs/heads/master'
  docker-build-upx:
    name: docker build upx
    runs-on: ubuntu-20.04
    container:
      image: hairyhenderson/dockerfiles-builder:latest
    env:
      BASHBREW_LIBRARY: ./library
      BASHBREW_NAMESPACE: hairyhenderson
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: build
      run: |
        bashbrew build upx
        img=$(bashbrew ls upx --uniq | head -n1)
        echo "IMG_NAME=${img}" >> $GITHUB_ENV
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMG_NAME }}
        format: 'template'
        template: '@/contrib/sarif.tpl'
        output: 'trivy-results.sarif'
        exit-code: 1
        ignore-unfixed: true
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'trivy-results.sarif'
      if: always() && github.repository == 'hairyhenderson/dockerfiles'
    - name: tag
      run: bashbrew tag --target-namespace ghcr.io/hairyhenderson upx
    - name: login
      run: |
        echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io --username ${{ github.actor }} --password-stdin
        echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login --username ${{ github.actor }} --password-stdin
      if: github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson'
    - name: push
      run: |
        bashbrew push --dry-run upx
        bashbrew push --dry-run --target-namespace ghcr.io/hairyhenderson upx
      if: github.ref != 'refs/heads/master' && github.repository == 'hairyhenderson/dockerfiles' && github.actor == 'hairyhenderson'
    - name: push
      run: |
        bashbrew push upx
        bashbrew push --target-namespace ghcr.io/hairyhenderson upx
      if: github.ref == 'refs/heads/master' && github.repository == 'hairyhenderson/dockerfiles'
